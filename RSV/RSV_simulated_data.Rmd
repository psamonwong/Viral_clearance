---
title: "RSV simulated data"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE) 

#Packages
library(tidymodels)
library(truncnorm)
```

Serial RSV viral loads were measured during a recent phase II human challenge study of a RSV directed antiviral: EDP-938. Individual patient viral load trajectories were not available, therefore mean viral load and standard errors were extracted from published data using a web tool (WebPlotDigitizer). n = 38 patients in the placebo group were challenged with RSV intranasally, infection was subsequently confirmed in n = 30 (for which viral load trajectories are available).

Viral load dynamics may differ between challenged and natural infection, adult RSV infection is thought to have lower peak viral loads and faster viral clearance than in childhood infection.

Here it is assumed that mean viral load is normally distributed at each timepoint.

### EDP-938: nonfusion replication inihibitor against N-protein of RSV 

Some qPCR data in this study were imputed by study authors if missing or below assay limit of detection at different timepoints. 

```{r, echo = FALSE}

rsv_edp <- read.csv("EDP938_placebo_vl.csv") %>%
  select(mean, se, time_innoc) %>%
  #Calculate standard deviation from SE and sample size (n = 30)
  mutate(sd = se * sqrt(30)) %>%
  #Round to 3 decimal places 
  mutate_if(is.numeric, round, digits = 3)

#Trial of simulated data 
set.seed(10400)
rsv_n <- 100
n_timepoints <- 20

#Empty dataframe to store results 
rsv_sim1 <- data.frame(id = character(), time = double(), vl = numeric()) 

#Simulate data 
for (case_id in 1:rsv_n) {
for (timepoint in 1:n_timepoints) {
  mean <- rsv_edp$mean[timepoint]
  sd <- rsv_edp$sd[timepoint]
  value <- rnorm(1, mean, sd)
  rsv_sim1 <- rbind(rsv_sim1, data.frame(id = paste0("case_", case_id),
                                         time = timepoint, 
                                         vl = value))
  }
}

ggplot(rsv_sim1, 
       aes(x = time, 
           y = vl, 
           group = id)) +
  geom_line(alpha = 0.3) + 
  theme_classic() + 
  labs(
    x = "Timepoint from RSV innoculation",
    y = "Simulated Viral Load log10 copies/mL", 
    title = "Simulated RSV VL from EDP-938 placebo group (NEJM)"
  ) + 
     scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0))
  
```

```{r, echo = FALSE}
#Repeat simulation, with truncated normal distribution 
rsv_sim2 <- data.frame(id = character(), time = double(), vl = numeric()) 

#Simulate data 
for (case_id in 1:rsv_n) {
for (timepoint in 1:n_timepoints) {
  mean <- rsv_edp$mean[timepoint]
  sd <- rsv_edp$sd[timepoint]
  value <- rtruncnorm(1, a = 0, b = Inf, mean, sd)
  rsv_sim2 <- rbind(rsv_sim2, data.frame(id = paste0("case_", case_id),
                                         time = timepoint, 
                                         vl = value))
  }
}

ggplot(rsv_sim2, 
       aes(x = time, 
           y = vl, 
           group = id)) +
  geom_line(alpha = 0.3) + 
  theme_classic() + 
  labs(
    x = "Timepoint from RSV innoculation",
    y = "Simulated Viral Load log10 copies/mL", 
    title = "Simulated RSV VL from EDP-938 placebo group (NEJM) - 
    truncated normal distribution"
  ) + 
   scale_x_continuous(expand = c(0, 0)) +
  scale_y_continuous(expand = c(0, 0))

```










